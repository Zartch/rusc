{% extends "base.html" %}
{% load staticfiles %}
{% load micawber_tags %}
{% block headers %}

    <script src="{% static 'js/jquery.formset.js' %}"></script>
    <script src="{% static 'js/custom-formset.js' %}"></script>
    <script src="{% static 'js/jquery.oembed.js' %}"></script>
    <link href="{% static 'css/select2.min.css' %}" rel="stylesheet" />
    <script src="{% static 'js/select2.js' %}"></script>
    <script src="{% static 'js/extracioLinks.js' %}"></script>

{% endblock  %}
{% block content %}
    <script type="text/javascript">
    $( document ).ready(function() {
        $('.id_text').on("keydown", function (e) {
            var etqProp = new Array;
            var paraula;
            var text = $('#id_text').val();
            var etiquetas = "{{etiquetas|safe}}";
            var words = /(\w+)/g;

            //cicle que llegeix el text i proposa etiquetes segons les paraules
            while (proposades = words.exec(text)) {
                paraula = proposades[0];
                etqProp.push(paraula);
            }
            if (etqProp.length > 0) {
                var div_proposta_etq = document.getElementById("div_proposta_etq");
                $("#div_proposta_etq").empty();

                for (i = 0; i < etqProp.length; i++) {
                    if (etqProp[i] in {{etiquetas|safe}}) {

                            var icon = document.createElement("span");
                            icon.className = "glyphicon glyphicon-tag";

                            btnetq = document.createElement('input');
                            btnetq.className = "btn btn-default btn-xs";
                            btnetq.name = "etq_prp_" + i;
                            btnetq.type = "button";
                            $dict = {{etiquetas|safe}};
                            btnetq.value = etqProp[i];
                            btnetq.id = $dict[etqProp[i]];
                            btnetq.onclick = function(event){
                                var select = $('.etiquetes');
                                var option = $('<option></option>').
                                     attr('selected', true).
                                     text(event.target.value).
                                     val(event.target.id);
                                /* insert the option (which is already 'selected'!) into the select */
                                option.appendTo(select);
                                /* Let select2 do whatever it likes with this */
                                select.trigger('change');
                                //alert("Has pres el bot√≥ "+event.target.id);
                            };


                            icon.appendChild(btnetq);
                            div_proposta_etq.appendChild(icon);
                    }
                }

            }
        });
    });
    </script>

    {% for post in reply_root %}
            {% for branch, obj in post.as_tree %}
                {% if obj %}
                    <li>
                        {# ToDo El if ha de trencar el Branch i no deixar d emostrar el titol  #}
                        {% if obj.pk <= id_pare %}
                          {{ obj.titol }}

                        {% endif %}
                    {% if branch %}
                        <ul>
                    {% else %}
                    </li>
                    {% endif %}
                {% else %}
                    {% if branch %}
                        </ul>
                    {% endif %}
                {% endif %}
            {% endfor %}
    {% endfor %}

    <form id="MyForm" method="post" action="">
        {% csrf_token %}
        {{ formPost.as_p }}
        <div id="div_proposta_etq"></div>
        <table>
        <div id="div_recursos"></div>
        <table>
        <tbody>
        {% for recurs_form in recurs_formset %}

            <div  class="recurs-formset" >
                <tr>
                <td>
                {{ recurs_form.descripcio }}
                {% if recurs_form.anchor.errors %}
                    {% for error in recurs_form.anchor.errors %}
                        {{ error|escape }}
                    {% endfor %}
                {% endif %}
                </td>
                <td>
                {{ recurs_form.url }}
                {% if recurs_form.url.errors %}
                    {% for error in recurs_form.url.errors %}
                        {{ error|escape }}
                    {% endfor %}
                {% endif %}
                </td>
{#                <td>#}
{#                    {{ recurs_form.etiquetes }}#}
{#                    {% if recurs_form.anchor.errors %}#}
{#                        {% for error in recurs_form.anchor.errors %}#}
{#                            {{ error|escape }}#}
{#                        {% endfor %}#}
{#                    {% endif %}#}
{#                </td>#}
                </tr>
            </div>
        {% endfor %}
        </tbody>
        </table>

        {{ recurs_formset.management_form }}
        {% if recurs_formset.non_form_errors %}
            {% for error in link_formset.non_form_errors %}
                {{ error|escape }}
            {% endfor %}
        {% endif %}
        <div id="links_results"></div>
        <p class="submit"><input type="submit" class="btn btn-primary" value="OK"></p>
    </form>



{% endblock %}
